# ============================================================================
# STAGE 1: Base Image with FFmpeg, Python, and AI Dependencies
# Build once, reuse forever
# ============================================================================
FROM amazonlinux:2 AS base-ai

# Install system dependencies
RUN yum update -y && \
    yum groupinstall -y "Development Tools" && \
    yum install -y wget tar gzip bzip2-devel nasm pkg-config cmake3 unzip \
                   fribidi-devel fontconfig-devel freetype-devel \
                   iputils bind-utils mysql \
                   openssl11 openssl11-devel ca-certificates \
                   zlib-devel libffi-devel sqlite-devel readline-devel xz-devel \
                   libjpeg-turbo-devel libpng-devel libtiff-devel giflib-devel \
                   libwebp-devel openjpeg2-devel lcms2-devel libxml2-devel \
                   librsvg2-devel libtool-ltdl-devel perl poppler-utils \
                   poppler-cpp-devel qpdf pkgconfig && \
    ln -sf /usr/bin/cmake3 /usr/bin/cmake && \
    yum clean all

# Create working directory
RUN mkdir -p /tmp/ffmpeg_sources

# Install librsvg with all its dependencies (includes HarfBuzz + Pango)
# This ensures they're all compatible with each other from the system repos
RUN yum install -y \
    librsvg2 \
    librsvg2-devel \
    librsvg2-tools \
    harfbuzz \
    harfbuzz-devel \
    pango \
    pango-devel \
    glib2-devel \
    cairo-devel \
    && yum clean all

# Build Ghostscript 10.02.1 from source (OCRmyPDF requires 9.55+)
RUN cd /tmp && \
    wget https://github.com/ArtifexSoftware/ghostpdl-downloads/releases/download/gs10021/ghostscript-10.02.1.tar.gz && \
    tar -xzf ghostscript-10.02.1.tar.gz && \
    cd ghostscript-10.02.1 && \
    ./configure --prefix=/usr/local && \
    make -j$(nproc) && \
    make install && \
    ldconfig && \
    ln -sf /usr/local/bin/gs /usr/bin/gs && \
    rm -rf /tmp/ghostscript-10.02.1*

# ============================================================================
# DOCUMENT CONVERSION DEPENDENCIES (SAFE ADDITIVE LAYER)
# Must be installed BEFORE ImageMagick-from-source and Python build
# ============================================================================

# ============================================================================
# Build Tesseract OCR from source (Amazon Linux 2 doesn't have it in repos)
# ============================================================================

# Install Leptonica (required by Tesseract)
RUN cd /tmp && \
    wget http://www.leptonica.org/source/leptonica-1.82.0.tar.gz && \
    tar -xzf leptonica-1.82.0.tar.gz && \
    cd leptonica-1.82.0 && \
    ./configure --prefix=/usr/local && \
    make -j$(nproc) && \
    make install && \
    ldconfig && \
    rm -rf /tmp/leptonica-1.82.0*

# Build Tesseract OCR from source
RUN cd /tmp && \
    wget https://github.com/tesseract-ocr/tesseract/archive/refs/tags/5.3.0.tar.gz && \
    tar -xzf 5.3.0.tar.gz && \
    cd tesseract-5.3.0 && \
    ./autogen.sh && \
    PKG_CONFIG_PATH="/usr/local/lib/pkgconfig:/usr/lib64/pkgconfig" ./configure --prefix=/usr/local && \
    make -j$(nproc) && \
    make install && \
    ldconfig && \
    rm -rf /tmp/tesseract-5.3.0* /tmp/5.3.0.tar.gz

# Download Tesseract language data files
RUN mkdir -p /usr/local/share/tessdata && \
    cd /usr/local/share/tessdata && \
    wget https://github.com/tesseract-ocr/tessdata/raw/main/eng.traineddata && \
    wget https://github.com/tesseract-ocr/tessdata/raw/main/spa.traineddata && \
    wget https://github.com/tesseract-ocr/tessdata/raw/main/fra.traineddata && \
    wget https://github.com/tesseract-ocr/tessdata/raw/main/deu.traineddata

# Set Tesseract data path
ENV TESSDATA_PREFIX=/usr/local/share/tessdata

# ============================================================================
# Install OCRmyPDF system dependencies (but NOT the Python package yet)
# We'll install the Python package AFTER Python is built
# ============================================================================
# Skip optional OCRmyPDF dependencies (not available in Amazon Linux 2)
# OCRmyPDF will work fine without these - they're only for image optimization

# Install ImageMagick WITHOUT custom HarfBuzz interference
# Use system libraries for SVG support
RUN cd /tmp && \
    wget https://github.com/ImageMagick/ImageMagick/archive/refs/tags/7.1.2-2.tar.gz && \
    tar -xzf 7.1.2-2.tar.gz && \
    cd ImageMagick-7.1.2-2 && \
    PKG_CONFIG_PATH="/usr/lib64/pkgconfig:/usr/lib/pkgconfig" \
    ./configure \
        --prefix=/usr/local \
        --with-quantum-depth=16 \
        --enable-hdri \
        --with-modules \
        --with-perl=no \
        --enable-shared \
        --enable-static \
        --with-webp=yes \
        --with-openjp2=yes \
        --with-gslib=yes \
        --with-rsvg=yes \
        --with-fontconfig=yes \
        --with-freetype=yes && \
    make -j$(nproc) && \
    make install && \
    ldconfig && \
    rm -rf /tmp/7.1.2-2.tar.gz /tmp/ImageMagick-7.1.2-2

# Install LAME
RUN cd /tmp/ffmpeg_sources && \
    wget https://downloads.sourceforge.net/project/lame/lame/3.100/lame-3.100.tar.gz && \
    tar -xzf lame-3.100.tar.gz && \
    cd lame-3.100 && \
    ./configure --prefix=/usr/local --enable-shared --enable-nasm && \
    make -j$(nproc) && \
    make install && \
    ldconfig

# Install Opus
RUN cd /tmp/ffmpeg_sources && \
    wget https://github.com/xiph/opus/releases/download/v1.4/opus-1.4.tar.gz && \
    tar -xzf opus-1.4.tar.gz && \
    cd opus-1.4 && \
    ./configure --prefix=/usr/local --enable-shared && \
    make -j$(nproc) && \
    make install && \
    ldconfig

# Install HarfBuzz from source for FFmpeg libass ONLY
# We install this AFTER ImageMagick to avoid conflicts
RUN cd /tmp/ffmpeg_sources && \
    wget https://github.com/harfbuzz/harfbuzz/releases/download/8.5.0/harfbuzz-8.5.0.tar.xz && \
    tar -xJf harfbuzz-8.5.0.tar.xz && \
    cd harfbuzz-8.5.0 && \
    ./configure --prefix=/usr/local && \
    make -j$(nproc) && \
    make install && \
    ldconfig

# Install libass
RUN cd /tmp/ffmpeg_sources && \
    wget https://github.com/libass/libass/releases/download/0.17.3/libass-0.17.3.tar.gz && \
    tar -xzf libass-0.17.3.tar.gz && \
    cd libass-0.17.3 && \
    PKG_CONFIG_PATH="/usr/local/lib/pkgconfig:/usr/lib64/pkgconfig:/usr/lib/pkgconfig" ./configure --prefix=/usr/local && \
    make -j$(nproc) && \
    make install && \
    ldconfig

# Install x264
RUN cd /tmp/ffmpeg_sources && \
    wget https://code.videolan.org/videolan/x264/-/archive/master/x264-master.tar.bz2 && \
    tar xjvf x264-master.tar.bz2 && \
    cd x264-master && \
    ./configure --enable-shared --enable-pic --prefix=/usr/local && \
    make -j$(nproc) && \
    make install && \
    ldconfig

# Install x265
RUN cd /tmp/ffmpeg_sources && \
    wget https://github.com/videolan/x265/archive/master.zip && \
    unzip master.zip && \
    cd x265-master/build/linux && \
    cmake -G "Unix Makefiles" -DCMAKE_INSTALL_PREFIX="/usr/local" -DENABLE_SHARED=ON ../../source && \
    make -j$(nproc) && \
    make install && \
    ldconfig

# Install FFmpeg
RUN cd /tmp/ffmpeg_sources && \
    wget https://ffmpeg.org/releases/ffmpeg-7.1.1.tar.gz && \
    tar -xzf ffmpeg-7.1.1.tar.gz && \
    cd ffmpeg-7.1.1 && \
    export PKG_CONFIG_PATH="/usr/local/lib/pkgconfig:/usr/lib64/pkgconfig:/usr/lib/pkgconfig" && \
    export CFLAGS="-I/usr/include/openssl11" && \
    export LDFLAGS="-L/usr/lib64/openssl11" && \
    ./configure \
        --prefix=/usr/local \
        --enable-gpl \
        --enable-nonfree \
        --enable-libx264 \
        --enable-libx265 \
        --enable-libass \
        --enable-libfreetype \
        --enable-libmp3lame \
        --enable-libopus \
        --enable-openssl \
        --extra-ldflags="-L/usr/local/lib -L/usr/lib64 -L/usr/lib64/openssl11" \
        --extra-cflags="-I/usr/local/include -I/usr/include -I/usr/include/openssl11" && \
    make -j$(nproc) && \
    make install && \
    ldconfig

# Build Python 3.11
RUN cd /tmp && \
    wget https://www.python.org/ftp/python/3.11.10/Python-3.11.10.tgz && \
    tar -xzf Python-3.11.10.tgz && \
    cd Python-3.11.10 && \
    export LD_LIBRARY_PATH=/usr/lib64/openssl11:/usr/local/lib:$LD_LIBRARY_PATH && \
    export CPPFLAGS="-I/usr/include/openssl11" && \
    export LDFLAGS="-L/usr/lib64/openssl11 -Wl,-rpath,/usr/lib64/openssl11" && \
    export PKG_CONFIG_PATH="/usr/lib64/openssl11/pkgconfig:$PKG_CONFIG_PATH" && \
    ./configure \
        --prefix=/usr/local \
        --enable-optimizations \
        --enable-shared \
        --with-openssl=/usr \
        --with-openssl-rpath=auto \
        --enable-loadable-sqlite-extensions && \
    LD_LIBRARY_PATH=/usr/lib64/openssl11:/usr/local/lib make -j$(nproc) && \
    LD_LIBRARY_PATH=/usr/lib64/openssl11:/usr/local/lib make altinstall && \
    ldconfig && \
    ln -sf /usr/local/bin/python3.11 /usr/local/bin/python3 && \
    ln -sf /usr/local/bin/python3.11 /usr/local/bin/python && \
    ln -sf /usr/local/bin/pip3.11 /usr/local/bin/pip3 && \
    ln -sf /usr/local/bin/pip3.11 /usr/local/bin/pip

# Install Python AI dependencies
RUN export LD_LIBRARY_PATH=/usr/lib64/openssl11:/usr/local/lib:$LD_LIBRARY_PATH && \
    /usr/local/bin/pip3.11 install --upgrade pip setuptools wheel

# ============================================================================
# DOCUMENT CONVERSION PYTHON DEPENDENCIES
# ============================================================================

RUN export LD_LIBRARY_PATH=/usr/lib64/openssl11:/usr/local/lib:$LD_LIBRARY_PATH && \
    /usr/local/bin/pip3.11 install \
        "pytesseract==0.3.10" \
        "pdf2image==1.16.3"

# ============================================================================
# NOW Install OCRmyPDF (AFTER Python is available)
# ============================================================================
RUN export LD_LIBRARY_PATH=/usr/lib64/openssl11:/usr/local/lib:$LD_LIBRARY_PATH && \
    /usr/local/bin/pip3.11 install \
        "ocrmypdf==15.4.4" \
        "beautifulsoup4==4.12.3" \
        "lxml==5.3.0" \
        "pikepdf==8.15.1"

# Verify OCRmyPDF installation (with proper library path)
RUN export LD_LIBRARY_PATH=/usr/lib64/openssl11:/usr/local/lib:$LD_LIBRARY_PATH && \
    /usr/local/bin/ocrmypdf --version && \
    echo "OCRmyPDF installed successfully"
RUN yum install -y poppler-utils

RUN export LD_LIBRARY_PATH=/usr/lib64/openssl11:/usr/local/lib:$LD_LIBRARY_PATH && \
    /usr/local/bin/pip3.11 install "torch==2.6.0+cpu" --index-url https://download.pytorch.org/whl/cpu && \
    /usr/local/bin/pip3.11 install "torchaudio==2.6.0+cpu" --index-url https://download.pytorch.org/whl/cpu

RUN export LD_LIBRARY_PATH=/usr/lib64/openssl11:/usr/local/lib:$LD_LIBRARY_PATH && \
    /usr/local/bin/pip3.11 install "numpy<2.0" "numpy>=1.21.0"

RUN export LD_LIBRARY_PATH=/usr/lib64/openssl11:/usr/local/lib:$LD_LIBRARY_PATH && \
    /usr/local/bin/pip3.11 install "onnxruntime==1.16.3"

RUN export LD_LIBRARY_PATH=/usr/lib64/openssl11:/usr/local/lib:$LD_LIBRARY_PATH && \
    /usr/local/bin/pip3.11 install "Pillow==10.4.0" && \
    /usr/local/bin/pip3.11 install "opencv-python-headless==4.10.0.84" && \
    /usr/local/bin/pip3.11 install "scipy==1.14.1"

RUN export LD_LIBRARY_PATH=/usr/lib64/openssl11:/usr/local/lib:$LD_LIBRARY_PATH && \
    /usr/local/bin/pip3.11 install "pymatting==1.1.13" "pooch==1.8.2" "tqdm==4.67.1" "requests==2.32.3" && \
    /usr/local/bin/pip3.11 install "jsonschema==4.23.0" "click==8.1.8" "aiohttp==3.11.11" && \
    /usr/local/bin/pip3.11 install "rembg==2.0.67"

RUN export LD_LIBRARY_PATH=/usr/lib64/openssl11:/usr/local/lib:$LD_LIBRARY_PATH && \
    /usr/local/bin/pip3.11 install "tiktoken==0.7.0"

RUN export LD_LIBRARY_PATH=/usr/lib64/openssl11:/usr/local/lib:$LD_LIBRARY_PATH && \
    echo "numpy<2.0" > /tmp/constraints.txt && \
    /usr/local/bin/pip3.11 install "openai-whisper==20250625" --constraint /tmp/constraints.txt

RUN export LD_LIBRARY_PATH=/usr/lib64/openssl11:/usr/local/lib:$LD_LIBRARY_PATH && \
    /usr/local/bin/pip3.11 install ffmpeg-python python-dotenv requests

RUN export LD_LIBRARY_PATH=/usr/lib64/openssl11:/usr/local/lib:$LD_LIBRARY_PATH && \
    /usr/local/bin/pip3.11 install yt-dlp && \
    ln -sf /usr/local/bin/yt-dlp /usr/bin/yt-dlp

RUN export LD_LIBRARY_PATH=/usr/lib64/openssl11:/usr/local/lib:$LD_LIBRARY_PATH && \
    /usr/local/bin/pip3.11 install "PyPDF2==3.0.1" && \
    /usr/local/bin/pip3.11 install "python-docx==1.1.2" && \
    /usr/local/bin/pip3.11 install "reportlab==4.2.5" && \
    /usr/local/bin/pip3.11 install "pypdf==3.17.4"

RUN export LD_LIBRARY_PATH=/usr/lib64/openssl11:/usr/local/lib:$LD_LIBRARY_PATH && \
    /usr/local/bin/pip3.11 install "python-pptx==1.0.2"

# Clean up build files
RUN rm -rf /tmp/ffmpeg_sources /tmp/Python-3.11.10* /tmp/*.tar.gz

# Configure library paths - CRITICAL: System libs come FIRST
RUN echo "/usr/lib64" > /etc/ld.so.conf.d/local-libs.conf && \
    echo "/usr/lib" >> /etc/ld.so.conf.d/local-libs.conf && \
    echo "/usr/lib64/openssl11" >> /etc/ld.so.conf.d/local-libs.conf && \
    echo "/usr/local/lib" >> /etc/ld.so.conf.d/local-libs.conf && \
    ldconfig

# Set base environment variables - System paths come FIRST
ENV LD_LIBRARY_PATH=/usr/lib64:/usr/lib:/usr/lib64/openssl11:/usr/local/lib
ENV PATH=/usr/local/bin:$PATH
ENV FFMPEG_PATH=/usr/local/bin/ffmpeg
ENV FFPROBE_PATH=/usr/local/bin/ffprobe
ENV PYTHON_PATH=/usr/local/bin/python3.11
ENV YT_DLP_PATH=/usr/local/bin/yt-dlp
ENV IMAGEMAGICK_PATH=/usr/local/bin/magick
ENV TESSERACT_PATH=/usr/local/bin/tesseract
ENV OCRMYPDF_PATH=/usr/local/bin/ocrmypdf
ENV OMP_NUM_THREADS=1
ENV OPENCV_IO_MAX_IMAGE_PIXELS=1073741824
ENV SSL_CERT_DIR=/etc/pki/tls/certs
ENV SSL_CERT_FILE=/etc/pki/tls/certs/ca-bundle.crt

# Verify installations
RUN export LD_LIBRARY_PATH=/usr/lib64/openssl11:/usr/local/lib:$LD_LIBRARY_PATH && \
    echo "Verifying installations..." && \
    /usr/local/bin/ffmpeg -version | head -1 && \
    /usr/local/bin/python3.11 --version && \
    /usr/local/bin/python3.11 -c "import ssl; print('SSL module available')" && \
    /usr/local/bin/python3.11 -c "import rembg; print('Rembg module available')" && \
    /usr/local/bin/python3.11 -c "import torch; print('PyTorch version:', torch.__version__)" && \
    /usr/local/bin/python3.11 -c "import PIL; print('Pillow version:', PIL.__version__)" && \
    /usr/local/bin/python3.11 -c "import ocrmypdf; print('OCRmyPDF module available')" && \
    /usr/local/bin/ocrmypdf --version && \
    echo "Setup verification complete."

# ============================================================================
# STAGE 2: Application Image (Lightweight - Spring Boot + Scripts)
# ============================================================================
FROM base-ai AS app

# Install Java 21
RUN rpm --import https://yum.corretto.aws/corretto.key && \
    curl -L -o /etc/yum.repos.d/corretto.repo https://yum.corretto.aws/corretto.repo && \
    yum install -y java-21-amazon-corretto java-21-amazon-corretto-devel mysql && \
    yum clean all

# Set Java environment
ENV JAVA_OPTS="-Xms384m -Xmx768m -XX:MaxMetaspaceSize=256m -XX:+UseG1GC"
ENV SPRING_PROFILES_ACTIVE=prod
ENV DOCUMENT_CONVERSION_SCRIPT_PATH=/app/scripts/document_converter.py

# Create application directories
RUN mkdir -p /app/scripts /temp/videoeditor/logs /temp/videoeditor/temp /temp/scripts && \
    chmod -R 777 /temp

WORKDIR /app

# Copy Python scripts
COPY scripts/remove_background.py /app/scripts/
COPY scripts/whisper_subtitle.py /app/scripts/
COPY scripts/whisper_subtitle.py /temp/scripts/
COPY scripts/compress_media.py /app/scripts/
COPY scripts/convert_media.py /app/scripts/
COPY scripts/whisper_transcribe.py /app/scripts/
COPY scripts/whisper_transcribe.py /temp/scripts/
COPY scripts/document_converter.py /app/scripts/
COPY scripts/ocr_postprocessor.py /app/scripts/
COPY scripts/ocr_postprocessor.py /temp/scripts/
COPY scripts/document_converter.py /temp/scripts/

# Make scripts executable
RUN chmod +x /app/scripts/*.py /temp/scripts/*.py

# Copy application configuration
COPY .env /app/.env
COPY credentials/video-editor-tts-24b472478ab838d2168992684517cacfab4c11da.json /app/credentials/video-editor-tts.json
COPY src/main/resources/email-templates/ /app/resources/email-templates/
COPY src/main/resources/image-gen-api-key.txt /app/credentials/image-gen-api-key.txt
# Copy Spring Boot JAR (this changes most frequently)
COPY target/Scenith-0.0.1-SNAPSHOT.jar app.jar

# Expose application port
EXPOSE 1000

# Run the application with CORRECT library path order
ENTRYPOINT ["sh", "-c", "export LD_LIBRARY_PATH=/usr/lib64:/usr/lib:/usr/lib64/openssl11:/usr/local/lib && export OMP_NUM_THREADS=1 && java $JAVA_OPTS -jar app.jar"]